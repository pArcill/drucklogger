version: '3.8'

services:
    postgres_database:
        image: postgres:15-alpine
        container_name: postgres_database
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        ports:
            - "${POSTGRES_PORT}:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
            interval: 10s
            timeout: 5s
            retries: 5

    mqtt_broker:
        image: eclipse-mosquitto:latest
        container_name: mqtt_broker
        ports:
            - "${MQTT_TCP_PORT}:1883"
            - "${MQTT_WS_PORT}:9001"
        volumes:
            - mosquitto_data:/mosquitto/data
            - mosquitto_logs:/mosquitto/log
            - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
        healthcheck:
            test: ["CMD", "mosquitto_sub", "-h", "localhost", "-t", "$$SYS/#", "-C", "1"]
            interval: 10s
            timeout: 5s
            retries: 5

    sensor_simulator:
        build: ./src/sensor_simulator
        container_name: sensor_simulator
        depends_on:
            mqtt_broker:
                condition: service_healthy
        environment:
            MQTT_BROKER: ${MQTT_BROKER}
            MQTT_PORT: ${MQTT_PORT}
            LOG_LEVEL: ${LOG_LEVEL}
        restart: unless-stopped

    fastapi_backend:
        build: ./src/fastapi_backend
        container_name: fastapi_backend
        ports:
            - "${API_PORT}:8000"
        depends_on:
            postgres_database:
                condition: service_healthy
            mqtt_broker:
                condition: service_healthy
        environment:
            DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}
            MQTT_BROKER: ${MQTT_BROKER}
            MQTT_PORT: ${MQTT_PORT}
            LOG_LEVEL: ${LOG_LEVEL}
        restart: unless-stopped

    nginx_frontend:
        image: nginx:alpine
        container_name: nginx_frontend
        ports:
            - "${NGINX_PORT}:80"
        volumes:
            - ./frontend/dist:/usr/share/nginx/html:ro
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
        depends_on:
            - fastapi_backend
        restart: unless-stopped

volumes:
    postgres_data:
    mosquitto_data:
    mosquitto_logs: